---
title: 2017-11-09-linux-ip-packet
date: 2017-11-09 19:22:25
tags:
---
  ip头部： ip首部长度20个字节，首部里面有个字段标识首部长度，4位，每位代表4个字节，4为最大表示15, 所以首部长度60个字节，除去20个字节固定长度，ip选项最长40个字节,
      ip校验和只适用于IP报头, 总长度用16位表示，单位是字节，包括报头

  ip选项格式： 

    type字段可以进一步分为三个部分，其中copied被设置时，假如需要分段，则需要把这个选项拷贝到每个片段, length表示整个选项的长度，point可以理解为当前的长度


  ip分段：
    ip头部有两个位用来表示分段相关，DF 禁止分段，MF后面还有分段, OFFSET表示原IP包的偏移量，13位,计算的时候需要左移三位(8字节对齐)
    ID字段是整个ip包都相同的，后续的重组需要使用这个字段。因为源路由根本就不知道有分段等因素，所以丢包的时候，只能把整个包都重新传输一遍，
    并且不会重用之前的ID。

    内核要识别一个片段所属的IP封包，内核会考虑下列参数：
      1 source ip, dest ip
      2 IP封包ID
      3 L4协议


    IP ID生成：
      linux 为每个目的地IP地址使用一个计数器, 遇到NAT的时候，还是有可能重复，导致两个封包都丢弃。 ipv6只允许源头分段，中间路由器不允许分段





