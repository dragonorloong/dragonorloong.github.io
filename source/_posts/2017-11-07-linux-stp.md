---
title: 2017-11-07-linux-stp
date: 2017-11-07 19:36:14
tags:
---

stp:
  BPDU: 网桥协议数据单元，用于STP协议的协商
  根网桥： 根网桥是唯一能产生bpdu的网桥，当拓扑发生改变时，根网桥确保网络中的每台网桥都知道此事
  指定网桥： 每个LAN都可以有一个指定网桥，它成为该LAN中所有主机和网桥到达根节点的网桥

  根端口： 网桥所有端口中，通往根网桥的路径开销最低的端口就会被选为根端口
  指定端口： 在每个LAN中，通往根网桥的路径开销最小的端口就会被选为指定端口

  端口状态：
    1 关闭
    2 阻塞
    3 监听
    4 学习
    5 转发

  网桥ID: 每个网桥都会分配一个ID，称为网桥ID，是一个8字节的数，最低的刘伟是某个网桥端口的MAC地址, 最高两个字节是优先级
  端口ID：每个端口都会被指定一个ID，一部分是根据端口在网桥的总线位置命名，第一个端口指定为1，第二个端口指定为2,端口ID的另外一部分是优先级，值较低的标识有较高优先级, 
        另外端口可以设置一个开销值


  优先级向量： 配额值BPDU的四个元素，根网桥ID，根路径开销，网桥ID以及端口ID

  TCN: 由检测到拓扑变化而且必须通知根网桥的网桥使用, 每隔hello事件发送一个TCN BPDU包给指定网桥，直到收到TCN BPDU的确认包
  TC: 由根网桥使用，当拓扑发生变化时，用于通知其他网桥, 在这段事件内，根网桥发送的BPDU都带上TC标识
  Aging: 用于从转发数据库中清理无效的地址
  HELLO: 每个定时器到期以后，根网桥就会产生一个配置bpdu
  Forward Deplay 定时器: 端口要过这么一段时间才会变成转发状态
  Message Age定时器： 网桥接收到尚未过期的BPDU时，会启动Message Age定时器, 定时器的事件为bpdu的生存期与最大生存期的差值，当这个定时器过期以后，这个端口就会重新指定角色(选择根端口)
  Hold: 配置BPDU的速率限制的定时器
  Short Aging定时器： 当转发数据库的地址一段时间没有数据通过，就会删除, 当收到带有TC标识的BPDU时，启动这个定时器

  收到BPDU配置信息可完成如下工作： 
    1 选出根网桥
    2 选出根端口
    3 对每个端口，为该端口所属的LAN分配指定网桥和指定端口

  根网桥选择：
    每个网桥启动的时候，会认为自己是根网桥，然后在所有的端口上发送BPDU，广播自己是根网桥，别的网桥收到这个BPDU时，假如本地的BPDU副本比收到的BPDU优先级高，就会回复BPDU，
    假如刚开始启动的网桥ID不是优先级最高的网桥，那么最后它肯定会收到一个配置BPDU，里面包含了更高级的根网桥ID，此时，该网桥会接收并记录这些级别较高的信息，相应地更新其端口的状态和角色

  选择根端口：
    根端口的选择就是遍历所有端口，然后选出拥有到达根网桥最佳路径的网桥，假如有两个以上的端口拥有相同的最佳优先级向量，则选择拥有最低端口ID的本地端口作为根端口


  根端口和指定端口是唯一处于转发状态的端口，消除临时环路主要通过forward deplay定时器来保证
    
