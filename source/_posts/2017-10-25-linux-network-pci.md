---
type: "tags"
layout: "tags"
title: linux pci设备/网卡知识总结
date: 2017-10-25 20:29:20
category: tcp/ip
toc: true
tags:
    - linux 
    - tcp/ip

description: 本章主要汇总网上搜集的一些资料，以及自己对网卡驱动，初始化，中断等方面知识的了解。因为内容比较底层，所以很多没有经过验证，只是试图自己说服自己而已。
comments: true
---

# 网卡初始化
  PCI是Peripheral Component Interconnect(外设部件互连标准)的缩写，它是目前个人电脑中使用最为广泛的接口，几乎所有的主板产品上都带有这种插槽。pci设备通过pci总线与内核联系，每种类型的pci设备都可以理解为有一个id。系统初始化的时候，会加载所有的驱动程序，驱动程序有个列表，里面会有它支持的pci设备列表。同样，系统初始化的时候，会在pci总线上面扫描其连接的所有pci设备，扫描到的设备会根据其ID，查找驱动程序，与驱动程序关联起来，调用驱动程序初始化该设备。初始化工作主要完成以下几件事情：
```
    1 完成pci设备本身内存/寄存器等和内核地址的映射
    2 分配中断号
    3 初始化net_device结构
```

网卡在接收完包或者发送完包以后，需要与内核交互，这时候就是通过发送硬件中断来通知内核的，在发包的时候，驱动程序负责把skb拷贝到映射的地址空间去，网卡的dma负载传输，传输完以后，发送中断给内核，驱动程序释放skb内存。 在接收包的时候，网卡发送中断通知内核，内核调用中断对应的驱动程序读取映射地址空间的数据，封装成skb，发送给内核协议栈处理，每个网卡都有一个net_device结构，很多的管理操作都是通过操作这个结构实现，其中这个结构会生成三个队列，第一个是通过链表实现的，所有网卡连接起来；第二个是以name为主键的hash表；第三个是网卡Id为主键的hash表。以上都是自己大概的了解，写得比较详细的有以下几个链接：
  ```
    http://bbs.chinaunix.net/thread-2010492-1-1.html
    https://segmentfault.com/a/1190000008836467
    https://segmentfault.com/a/1190000008926093
  ```

# 网卡中断
  网卡中断的处理方式上面已经说了，这里说的是网卡多队列，现在的网卡都支持多队列，每个队列申请一个中断号，收包的时候，通过hash(sip，sport, dip, sport)，收到一个队列里面，并且触发相应的中断，默认情况下，所有网卡中断都绑定到第一个cpu，很容易导致第一个cpu因为处理中断跑满cpu，可以通过配置cpu与中断的绑定关系，这个有很多想关的帖子，所以不再多说

# 网卡类型
  目前了解的网卡类型包括tun/tap, 这种类型网卡一端与用户进程连接，一端与协议栈相连，典型用途就是vpn, tun和tap的区别就是一个是l3,一个是l2。bridge就是交换机的概念，假如在上面配置ip的话，会与协议栈相连，与网桥相连的网卡都不会往协议栈转发数据，收到的数据都会转发给网桥，通过网桥转发出去。veth是一对设备，收到的数据会转发给对端。这个后面会研究kvm和lxc，docker等虚拟化类型的网络传输方式。bond类型网卡是把多张物理网卡虚拟化一张网卡，有好几种模式，主要用于高可用，简化应用等。
