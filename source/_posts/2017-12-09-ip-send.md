---
title: 2017-12-09-ip-send
date: 2017-12-09 12:49:56
tags:
---
ip 传输有几个重要的函数，分别是ip_append_data, ip_queue_xmit, ip_addend_page, ip_push_pending_frames
另外，每个skbuffer都会与一个sock关联起来，skb->sk指向sock
这几个函数分别由上层协议调用的关系如下图所示：


ip_quque_xmit主要用于tcp， stcp使用，上层协议已经协助分段，所以整体逻辑比较简单：
    该函数主要完成ip选项的设置，ip头部设置，路径设置，然后经过netfilter模块以后，送给下层协议
    对于设置了源路由选型，但是路由的下一跳不等于这个地址，则会丢掉这个包

    return NF_HOOK(PF_INET, NF_IP_LOCAL_OUT, skb, NULL, rt->u.dst.dev,
                    dst_output);

ip_append_data:
    该函数是l4把数据放到缓存中，但是不要马上发送的函数, 假如要刷新缓存，需要显示调用ip_push_pending_frames。缓存中的数据最多只能达到
    最大的ip报文，也就是64KB, 该函数的主要任务为：
        1 把l4的报文分隔成一些易于分段的缓存，优化内存分配
        2 计算l4校验和

    在没有设置MSG_MORE标识时，ip_append_data每次调用都会创建和传输数据一致大小的报文(包括l3/l2头部), 并且把这些报文通过skb链接起来
    假如设置了MSG_MORE时，表示马上就会有下一次调用，这样在分配内存时，会申请MTU大小

    分散/聚集IO: 需要传输的数据，没必要放在连续的内存中，可以以分散的方式链接起来，后续直接发送出去，优点是能够减少内存的分配和拷贝
    在ip_append_data函数中，假如支持分散/聚集IO，第一次调用时会分配内存，并且拷贝，后续的l4数据在单个skb小于PMTU时，直接通过skb的frags
    链接起来, 对于每个分段skb, 放到inet_sock 的skb_write_queue中链接起来

    ip_append_data传递进来的l4数据，需要拷贝时候，因为数据可能来自用户空间，也可能来自内核空间，所以对于数据的拷贝函数，是使用参数传递进来

ip_append_page:
    当设备支持分散/聚集IO时，可以使用这个函数，该函数不会拷贝内存，只是把l4的数据链接到frages的数组中， 并且计算l4检验和

ip_push_pending_frames:
    该函数把skb_write_queue中的skb重新链接，使用frag_list字段，另外会填充l3头部，l4头部，ip选项等。然后投递给netfilter模块，最后通过设备发送出去

ip_fragment:
    该函数用于处理分段，对于本地传递的例如UDP和TCP等产生的skb，frag_list不为空，使用快速分段法，快速分段发很简单，就是处理一下ip头部，就直接发送出去了
    假如不满足快速分段的条件，就会使用慢速分段方法，每次创建skb，拷贝内存等，然后发送出去


icmp:
    网络控制协议, 常见的使用icmp的地方包括ping, traceroute等，路由重定向，时间请求等。假如发送包给udp的端口不存在，会返回一个icmp包，所以可以根据这个
    探测udp端口，icmp会在每个cpu绑定一个内核套接字，用于处理icmp。ip曾的icmp错误报文会携带ip头部和传输层的前4字节
