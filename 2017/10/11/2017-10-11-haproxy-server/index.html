<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="澳门新葡京"><title>Haproxy 后端server/健康检查 | 天天反水, 美女荷官发牌   ---澳门新葡京</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Haproxy 后端server/健康检查</h1><a id="logo" href="/.">天天反水, 美女荷官发牌   ---澳门新葡京</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Haproxy 后端server/健康检查</h1><div class="post-meta">Oct 11, 2017<span> | </span><span class="category"><a href="/categories/Haprxoy/">Haprxoy</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Haproxy-Server管理"><span class="toc-number">1.</span> <span class="toc-text">Haproxy Server管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#连接数"><span class="toc-number">1.2.</span> <span class="toc-text">连接数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http相关"><span class="toc-number">1.3.</span> <span class="toc-text">http相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#keep-alive"><span class="toc-number">1.3.1.</span> <span class="toc-text">keep-alive</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#连接复用"><span class="toc-number">1.3.2.</span> <span class="toc-text">连接复用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#健康检查"><span class="toc-number">1.4.</span> <span class="toc-text">健康检查</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#负载均衡算法"><span class="toc-number">2.</span> <span class="toc-text">负载均衡算法</span></a></li></ol></div></div><div class="post-content"><h1 id="Haproxy-Server管理"><a href="#Haproxy-Server管理" class="headerlink" title="Haproxy Server管理"></a>Haproxy Server管理</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server配置如下：</span><br><span class="line">    server &lt;name&gt; &lt;address&gt;[:[port]] [param*]</span><br><span class="line"></span><br><span class="line">name: 必须保证在同一个backend中唯一</span><br><span class="line"></span><br><span class="line">address: 可以加个前缀，指定后端地址的类型，</span><br><span class="line">   支持ipv4,ipv6, unix domain, namespace</span><br><span class="line"></span><br><span class="line">port: 假如不指定时，使用客户端连过来的端口，</span><br><span class="line">    也可以使用-1,+2,这样表示在客户端的端口上减去1，</span><br><span class="line">    例如客户端连接127.0.0.1:83，配置-1以后，</span><br><span class="line">    后端的端口为83-1=82</span><br><span class="line"></span><br><span class="line">param: 包括健康检查check，代理agent，cookie等</span><br></pre></td></tr></table></figure>
<h2 id="连接数"><a href="#连接数" class="headerlink" title="连接数"></a>连接数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">关于连接限制，maxconn可以定义在global，default，listener，frontend, server这几个地方，</span><br><span class="line">另外还有minconn, maxconn， fullconn等，比较混乱，下面分析下各个参数的具体意思，从一个配置入手：</span><br><span class="line"></span><br><span class="line">global</span><br><span class="line">    maxconn 81920 //整个进程所有前端加起来最多accept 81920个连接</span><br><span class="line"></span><br><span class="line">default</span><br><span class="line">    maxconn 10240  //单个frontend最多accept 10240个连接</span><br><span class="line"></span><br><span class="line">backend be</span><br><span class="line">    //当server的minconn和maxconn设置了以后， fullconn才有意义</span><br><span class="line">    //fullconn默认值是引用它的frontend的maxconn累加 除以10，(1024+1000+9)/10, 加9是为了向下取整</span><br><span class="line">    //fullconn的意义是，当backend的所有server的连接数加起来超过了fullconn 1024,认为这个backend已经处于</span><br><span class="line">    //高负载情况，这时候，server-1的最大连接数为maxconn 100，否则server-1的最大连接数为minconn 10</span><br><span class="line">    fullconn 1024 </span><br><span class="line">    //作者的解释：http://thread.gmane.org/gmane.comp.web.haproxy/5357</span><br><span class="line">    //  - minconn defines the limit when load is low</span><br><span class="line">    //  - maxconn defines the limit when load is high</span><br><span class="line">    //  - fullconn defines what a high load is</span><br><span class="line"></span><br><span class="line">    server server-1 192.168.0.5:8080 minconn 10 maxconn 100</span><br><span class="line">    server server-2 192.168.0.6:8080 minconn 1000 maxconn 10000</span><br><span class="line">    </span><br><span class="line">frontend fe1</span><br><span class="line">    bind :8080</span><br><span class="line">    maxconn 1024 //fronend fe1 最大accept个数为1024</span><br><span class="line">    use-backend be</span><br><span class="line">    </span><br><span class="line">frontend fe2</span><br><span class="line">    bind :8081</span><br><span class="line">    maxconn 1000</span><br><span class="line">    use-backend be</span><br></pre></td></tr></table></figure>
<h2 id="http相关"><a href="#http相关" class="headerlink" title="http相关"></a>http相关</h2><h3 id="keep-alive"><a href="#keep-alive" class="headerlink" title="keep-alive"></a>keep-alive</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">option http-keepalive //默认选项，对于client带有conntion: keep-alive的选项，保持连接</span><br><span class="line">option http-server-close //客户端保持连接，服务端关闭连接</span><br><span class="line">option forceclose //完成整个响应以后，关闭两端连接</span><br><span class="line">option http-tunnel //只有第一个请求被解析，后面的内容只是透明转发, 当在头部中发现upgrade字段时，也会转变成这种模式，所以haproxy天生支持websocket</span><br><span class="line">option httpclose //在请求和响应两端分别加上connection: close字段</span><br></pre></td></tr></table></figure>
<h3 id="连接复用"><a href="#连接复用" class="headerlink" title="连接复用"></a>连接复用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//对于默认情况下，client带了keep-alive header时，后端连接会保留，这时候</span><br><span class="line">//连接可以下次的重复使用，即多个客户端先后使用同一个服务端</span><br><span class="line">http-reuse never //永远不重复利用，默认选项</span><br><span class="line">http-reuse safe //client的第一个请求新建后端连接，后续请求可以复用之前别的client遗留下来的连接</span><br><span class="line">http-reuse aggressive //client的第一个请求只会复用之前已经复用过一次及以上的遗留连接</span><br><span class="line">http-reuse always //总是重复利用之前遗留的连接</span><br></pre></td></tr></table></figure>
<h2 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">健康检查涉及到的配置参数：</span><br><span class="line">    global</span><br><span class="line">        //程序启动开始计时，到第一次健康检查执行的最大间隔时间</span><br><span class="line">        //为了防止多个健康检查同时运行，第一次健康检查的时间为:</span><br><span class="line">        //min(inter, max-spread-checks)*index/total，其中index是server的位置，</span><br><span class="line">        //total是整个进程中，server的个数</span><br><span class="line">        //后面的每次健康检查间隔时间也会减去一个随机时间，随机因子中有max-spread-checks</span><br><span class="line">        max-spread-checks </span><br><span class="line">        </span><br><span class="line">    backend be</span><br><span class="line">        //健康检查方法1</span><br><span class="line">            //http健康检查，后面可以指定方法</span><br><span class="line">            option httpchk GET /</span><br><span class="line">            //返回码只有2/3开头才会认为检查是成功的</span><br><span class="line">            http-check expect rstatus ^[23]</span><br><span class="line">            //发送服务器的健康检查状态给后端</span><br><span class="line">            http-check send-state</span><br><span class="line">            //返回404时，进入维修模式，请求不会转发到这个后端，可以作为http服务器升级使用</span><br><span class="line">            http-check disable-on-404</span><br><span class="line">        </span><br><span class="line">        //健康检查方法2</span><br><span class="line">            //tcp健康检查</span><br><span class="line">            //可能在一个ip上面绑定多个端口，这样健康检查可以像下面这样做，</span><br><span class="line">            //haproxy先连110端口，检查返回值，再连143端口，发送test字符串，</span><br><span class="line">            //再检查返回值，整个过程是一个事务，都成功，才认为</span><br><span class="line">            //这次检查的结果是健康的</span><br><span class="line">            option tcp-checkoption tcp-check</span><br><span class="line">            tcp-check connect port 110</span><br><span class="line">            tcp-check expect string +OK\ POP3\ ready</span><br><span class="line">            tcp-check connect port 143</span><br><span class="line">            tcp-check send test</span><br><span class="line">            tcp-check expect string *\ OK\ IMAP4\ ready</span><br><span class="line">            server mail 10.0.0.1 check</span><br><span class="line">        </span><br><span class="line">        //健康检查方法3</span><br><span class="line">            //外部健康检查，调用外部进程来完成健康检查，健康检查的结果通过捕获子进程退出的</span><br><span class="line">            //信号，waitpid 获取子进程退出码，退出状态为0代表健康</span><br><span class="line">            //传给子进程的参数通过注入环境变量完成</span><br><span class="line">            option external-check</span><br><span class="line">            //外部进程</span><br><span class="line">            external-check command /bin/true</span><br><span class="line">            //外部进程的PATH环境变量</span><br><span class="line">            external-check path &quot;/usr/bin:/bin&quot;</span><br><span class="line">            </span><br><span class="line">        //另外还支持多种健康检查方式，例如redis，mysql，smtp等</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        //代理健康检查，agent，主要用于后端服务的升级</span><br><span class="line">        //当后端服务要升级时，先后端服务商listen 18080端口，然后haproxy会检测这个端口打开</span><br><span class="line">        //会连接上去，这时候返回maint字符串，haproxy收到这个字符串以后，会把后端设置为维修模式，</span><br><span class="line">        //这样，就不会有新的连接过来了，等老的连接断掉以后，把服务器升级重启，</span><br><span class="line">        //然后再发送ready给haproxy，haproxy把server放到正常的队列里面，开始提供服务</span><br><span class="line">        </span><br><span class="line">        //除了一开始发送maint，也可以发送up，down来设置server的状态</span><br><span class="line">        server server1 192.168.1.3:8080 check inter 5s agent-check agent-inter 10s age</span><br><span class="line">nt-port 18080</span><br><span class="line"></span><br><span class="line">        //因为haproxy的server启动时，默认server是可用的，</span><br><span class="line">        //配置slowstart以后，会在启动的时候，每次增加权重的5%，在配置的时间内(10s)内完成整个启动</span><br><span class="line">        server slowstart-server 192.168.1.3:8081 slowstart 10s</span><br></pre></td></tr></table></figure>
<h1 id="负载均衡算法"><a href="#负载均衡算法" class="headerlink" title="负载均衡算法"></a>负载均衡算法</h1><p>首先分为两个二叉树， 正常和备用连接数，只有在正常的全挂了，才会使用备用服务器列表</p>
<p>加权最少连接数：<br>使用当前连接数/权重当做key，每次都取key最小的服务，每次分配都先会更新key，更新key是先出队列，然后再入队。</p>
<p>加权轮询：<br>用户设置的最大权值为max=256，初始key为用户的max_weight - weight，这样weight越大，key越小，优先级越高。<br>total = weight1 + weight2, 以后每次都是key的增长值为max*(total/weight1)， 这样保证总是成反比例增长。</p>
<p>first:<br>总是取server id值最小的后端</p>
<p>static-rr<br>分配一个所有server大小的数组，选取key + total/total 最大的server ，分配到数组当前位置，然后key再增加weight，<br>继续分配，基本上按key占的比例分配席位, 获取server时，轮询数组<br>缺点: 有服务加入时，需要重新分配数组</p>
<p>source  map-based<br>和上面算法一样，用client ip获取hash作为数组的下标</p>
<p>source consistent<br>一致性hash算法，根据权重，在红黑树中，根据权重比重设置份额，假如server 健康检查失败，从树中删除节点，<br>之前匹配的ip，分配到pre node或者next node中</p>
</div><div class="tags"><a href="/tags/Haproxy/">Haproxy</a><a href="/tags/负载均衡/">负载均衡</a></div><div class="post-nav"><a href="/2017/10/12/2017-10-12-haproxy-cookie/" class="pre">Haproxy cookie</a><a href="/2017/10/10/2017-10-10-haproxy-memory/" class="next">Haproxy 内存管理</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Haprxoy/">Haprxoy</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Https/">Https</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tcp-ip/">tcp/ip</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Haproxy/" style="font-size: 15px;">Haproxy</a> <a href="/tags/负载均衡/" style="font-size: 15px;">负载均衡</a> <a href="/tags/Https/" style="font-size: 15px;">Https</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/04/12/2018-04-12-haproxy-port-reuse/">Haproxy 端口复用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/27/2018-02-26-netfilter/">netfilter 框架及lvs的实现原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/21/2018-01-21-linux-close/">linux close 过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/20/2018-01-20-tcp-rcv/">linux tcp recv 调用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/17/2018-01-17-linux-send/">linux tcp send过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/15/2018-01-15-linux-connect/">linux connect 过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/10/2018-01-10-linux-tcp-server-handshake-2/">linux tcp 服务端ack接收</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/04/2018-04-linux-tcp-server-handshake/">linux tcp 服务端syn包接收</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/03/2018-01-03-linux-listen/">linux listen 过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/02/2018-01-02-udp-msg-handler/">linux udp 数据接收和发送过程</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">天天反水, 美女荷官发牌   ---澳门新葡京.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>