<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="澳门新葡京"><title>linux tcp 服务端syn包接收 | 天天反水, 美女荷官发牌   ---澳门新葡京</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">linux tcp 服务端syn包接收</h1><a id="logo" href="/.">天天反水, 美女荷官发牌   ---澳门新葡京</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">linux tcp 服务端syn包接收</h1><div class="post-meta">Jan 4, 2018</div><div class="post-content"><h1 id="主要函数调用栈"><a href="#主要函数调用栈" class="headerlink" title="主要函数调用栈"></a>主要函数调用栈</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tcp_v4_rcv</span><br><span class="line"> -&gt;tcp_v4_do_rcv</span><br><span class="line">    -&gt;tcp_rcv_state_process</span><br><span class="line">       -&gt;tcp_v4_conn_request</span><br><span class="line">          -&gt;tcp_v4_send_synack</span><br></pre></td></tr></table></figure>
<p>本章只说明主要流程，具体的例如超时处理，time_wait等后面专门细化<br>收到syn包的处理流程大概是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1 检查包格式</span><br><span class="line">2 在hash表中查找listen sk</span><br><span class="line">3 创建连接请求块，链接到半连接队列</span><br><span class="line">4 构建syn/ack包，回包</span><br><span class="line">5 设置定时器，处理超时情况</span><br></pre></td></tr></table></figure></p>
<h1 id="详细流程"><a href="#详细流程" class="headerlink" title="详细流程"></a>详细流程</h1><p>入口函数在之前协议簇初始化时，就已经注册了tcp协议对应的处理函数,<br>在ip层收到tcp包时，会调用tcp_v4_rcv处理</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_protocol</span> <span class="title">tcp_protocol</span> = &#123;</span></span><br><span class="line">  .handler =  tcp_v4_rcv,</span><br><span class="line">  .err_handler =  tcp_v4_err,</span><br><span class="line">  .gso_send_check = tcp_v4_gso_send_check,</span><br><span class="line">  .gso_segment =  tcp_tso_segment,</span><br><span class="line">  .no_policy =  <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_v4_rcv</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">th</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line">  <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//不是发往本地的包，丢弃</span></span><br><span class="line">  <span class="keyword">if</span> (skb-&gt;pkt_type != PACKET_HOST)</span><br><span class="line">    <span class="keyword">goto</span> discard_it;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Count it even if it's bad */</span></span><br><span class="line">  TCP_INC_STATS_BH(TCP_MIB_INSEGS);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//拷贝标准tcp头部到线性缓冲区</span></span><br><span class="line">  <span class="keyword">if</span> (!pskb_may_pull(skb, <span class="keyword">sizeof</span>(struct tcphdr)))</span><br><span class="line">    <span class="keyword">goto</span> discard_it;</span><br><span class="line"></span><br><span class="line">  th = skb-&gt;h.th;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//标准长度和doff字段比较</span></span><br><span class="line">  <span class="keyword">if</span> (th-&gt;doff &lt; <span class="keyword">sizeof</span>(struct tcphdr) / <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad_packet;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//获取包括tcp选项的头部到线性缓冲区</span></span><br><span class="line">  <span class="keyword">if</span> (!pskb_may_pull(skb, th-&gt;doff * <span class="number">4</span>))</span><br><span class="line">    <span class="keyword">goto</span> discard_it;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* An explanation is required here, I think.</span></span><br><span class="line"><span class="comment">   * Packet length and doff are validated by header prediction,</span></span><br><span class="line"><span class="comment">   * provided case of th-&gt;doff==0 is eliminated.</span></span><br><span class="line"><span class="comment">   * So, we defer the checks. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//校验和相关</span></span><br><span class="line">  <span class="keyword">if</span> ((skb-&gt;ip_summed != CHECKSUM_UNNECESSARY &amp;&amp;</span><br><span class="line">       tcp_v4_checksum_init(skb)))</span><br><span class="line">    <span class="keyword">goto</span> bad_packet;</span><br><span class="line"></span><br><span class="line">  th = skb-&gt;h.th;</span><br><span class="line">  TCP_SKB_CB(skb)-&gt;seq = ntohl(th-&gt;seq);</span><br><span class="line">  <span class="comment">//end_seq是首部的seq字段，加上数据长度</span></span><br><span class="line">  TCP_SKB_CB(skb)-&gt;end_seq = (TCP_SKB_CB(skb)-&gt;seq + th-&gt;syn + th-&gt;fin +</span><br><span class="line">            skb-&gt;len - th-&gt;doff * <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//对端的确认号</span></span><br><span class="line">  TCP_SKB_CB(skb)-&gt;ack_seq = ntohl(th-&gt;ack_seq);</span><br><span class="line">  TCP_SKB_CB(skb)-&gt;when  = <span class="number">0</span>;</span><br><span class="line">  TCP_SKB_CB(skb)-&gt;flags   = skb-&gt;nh.iph-&gt;tos;</span><br><span class="line">  TCP_SKB_CB(skb)-&gt;sacked  = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//根据四元组到tcp_hashinfo中查找对应的sk</span></span><br><span class="line">  <span class="comment">//先在established中查找，然后到listener中查询</span></span><br><span class="line">  sk = __inet_lookup(&amp;tcp_hashinfo, skb-&gt;nh.iph-&gt;saddr, th-&gt;source,</span><br><span class="line">         skb-&gt;nh.iph-&gt;daddr, th-&gt;dest,</span><br><span class="line">         inet_iif(skb));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!sk)</span><br><span class="line">    <span class="keyword">goto</span> no_tcp_socket;</span><br><span class="line"></span><br><span class="line">process:</span><br><span class="line">  <span class="keyword">if</span> (sk-&gt;sk_state == TCP_TIME_WAIT)</span><br><span class="line">    <span class="keyword">goto</span> do_time_wait;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!xfrm4_policy_check(sk, XFRM_POLICY_IN, skb))</span><br><span class="line">    <span class="keyword">goto</span> discard_and_relse;</span><br><span class="line">  nf_reset(skb);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sk_filter(sk, skb))</span><br><span class="line">    <span class="keyword">goto</span> discard_and_relse;</span><br><span class="line"></span><br><span class="line">  skb-&gt;dev = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  bh_lock_sock_nested(sk);</span><br><span class="line">  ret = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">//判断有没有进程在处理当前sk，没有的话进入这个分支</span></span><br><span class="line">  <span class="keyword">if</span> (!sock_owned_by_user(sk)) &#123;</span><br><span class="line">  <span class="comment">//dma没有了解</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_DMA</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> = <span class="title">tcp_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="keyword">if</span> (!tp-&gt;ucopy.dma_chan &amp;&amp; tp-&gt;ucopy.pinned_list)</span><br><span class="line">      tp-&gt;ucopy.dma_chan = get_softnet_dma();</span><br><span class="line">    <span class="keyword">if</span> (tp-&gt;ucopy.dma_chan)</span><br><span class="line">      ret = tcp_v4_do_rcv(sk, skb);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//http://blog.csdn.net/dog250/article/details/5464513 讲prequeue存在的理由</span></span><br><span class="line">      <span class="keyword">if</span> (!tcp_prequeue(sk, skb))</span><br><span class="line">      ret = tcp_v4_do_rcv(sk, skb);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span></span><br><span class="line">  <span class="comment">//有进程在处理当前sk，插入报文到backlog</span></span><br><span class="line">    sk_add_backlog(sk, skb);</span><br><span class="line">  bh_unlock_sock(sk);</span><br><span class="line"></span><br><span class="line">  sock_put(sk);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">no_tcp_socket:</span><br><span class="line">  <span class="keyword">if</span> (!xfrm4_policy_check(<span class="literal">NULL</span>, XFRM_POLICY_IN, skb))</span><br><span class="line">    <span class="keyword">goto</span> discard_it;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (skb-&gt;len &lt; (th-&gt;doff &lt;&lt; <span class="number">2</span>) || tcp_checksum_complete(skb)) &#123;</span><br><span class="line">bad_packet:</span><br><span class="line">    TCP_INC_STATS_BH(TCP_MIB_INERRS);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//发送reset包</span></span><br><span class="line">    tcp_v4_send_reset(<span class="literal">NULL</span>, skb);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">discard_it:</span><br><span class="line">  <span class="comment">/* Discard frame. */</span></span><br><span class="line">  kfree_skb(skb);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">discard_and_relse:</span><br><span class="line">  sock_put(sk);</span><br><span class="line">  <span class="keyword">goto</span> discard_it;</span><br><span class="line"></span><br><span class="line">do_time_wait:</span><br><span class="line">  <span class="keyword">if</span> (!xfrm4_policy_check(<span class="literal">NULL</span>, XFRM_POLICY_IN, skb)) &#123;</span><br><span class="line">    inet_twsk_put(inet_twsk(sk));</span><br><span class="line">    <span class="keyword">goto</span> discard_it;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (skb-&gt;len &lt; (th-&gt;doff &lt;&lt; <span class="number">2</span>) || tcp_checksum_complete(skb)) &#123;</span><br><span class="line">    TCP_INC_STATS_BH(TCP_MIB_INERRS);</span><br><span class="line">    inet_twsk_put(inet_twsk(sk));</span><br><span class="line">    <span class="keyword">goto</span> discard_it;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (tcp_timewait_state_process(inet_twsk(sk), skb, th)) &#123;</span><br><span class="line">  <span class="keyword">case</span> TCP_TW_SYN: &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk2</span> = <span class="title">inet_lookup_listener</span>(&amp;<span class="title">tcp_hashinfo</span>,</span></span><br><span class="line"><span class="class">              <span class="title">skb</span>-&gt;<span class="title">nh</span>.<span class="title">iph</span>-&gt;<span class="title">daddr</span>,</span></span><br><span class="line"><span class="class">              <span class="title">th</span>-&gt;<span class="title">dest</span>,</span></span><br><span class="line"><span class="class">              <span class="title">inet_iif</span>(<span class="title">skb</span>));</span></span><br><span class="line">    <span class="keyword">if</span> (sk2) &#123;</span><br><span class="line">      inet_twsk_deschedule(inet_twsk(sk), &amp;tcp_death_row);</span><br><span class="line">      inet_twsk_put(inet_twsk(sk));</span><br><span class="line">      sk = sk2;</span><br><span class="line">      <span class="keyword">goto</span> process;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Fall through to ACK */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> TCP_TW_ACK:</span><br><span class="line">    tcp_v4_timewait_ack(sk, skb);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> TCP_TW_RST:</span><br><span class="line">    <span class="keyword">goto</span> no_tcp_socket;</span><br><span class="line">  <span class="keyword">case</span> TCP_TW_SUCCESS:;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">goto</span> discard_it;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">假如不是放到prequeue中， 回调用tcp_v4_do_rcv函数处理</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_v4_do_rcv</span><span class="params">(struct sock *sk, struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">rsk</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TCP_MD5SIG</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * We really want to reject the packet as early as possible</span></span><br><span class="line"><span class="comment">   * if:</span></span><br><span class="line"><span class="comment">   *  o We're expecting an MD5'd packet and this is no MD5 tcp option</span></span><br><span class="line"><span class="comment">   *  o There is an MD5 option and we're not expecting one</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (tcp_v4_inbound_md5_hash(sk, skb))</span><br><span class="line">    <span class="keyword">goto</span> discard;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sk-&gt;sk_state == TCP_ESTABLISHED) &#123; <span class="comment">/* Fast path */</span></span><br><span class="line">    TCP_CHECK_TIMER(sk);</span><br><span class="line">    <span class="keyword">if</span> (tcp_rcv_established(sk, skb, skb-&gt;h.th, skb-&gt;len)) &#123;</span><br><span class="line">      rsk = sk;</span><br><span class="line">      <span class="keyword">goto</span> reset;</span><br><span class="line">    &#125;</span><br><span class="line">    TCP_CHECK_TIMER(sk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//计算检验和</span></span><br><span class="line">  <span class="keyword">if</span> (skb-&gt;len &lt; (skb-&gt;h.th-&gt;doff &lt;&lt; <span class="number">2</span>) || tcp_checksum_complete(skb))</span><br><span class="line">    <span class="keyword">goto</span> csum_err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//处于TCP_LISTEN状态的sk，进入这个分支</span></span><br><span class="line">  <span class="keyword">if</span> (sk-&gt;sk_state == TCP_LISTEN) &#123;</span><br><span class="line">    <span class="comment">//第一次请求，在半连接队列中找不到对应的sock, 返回sk本身</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">nsk</span> = <span class="title">tcp_v4_hnd_req</span>(<span class="title">sk</span>, <span class="title">skb</span>);</span></span><br><span class="line">    <span class="keyword">if</span> (!nsk)</span><br><span class="line">      <span class="keyword">goto</span> discard;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nsk != sk) &#123;</span><br><span class="line">      <span class="keyword">if</span> (tcp_child_process(sk, nsk, skb)) &#123;</span><br><span class="line">        rsk = nsk;</span><br><span class="line">        <span class="keyword">goto</span> reset;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  TCP_CHECK_TIMER(sk);</span><br><span class="line">  <span class="comment">//进去这个分支</span></span><br><span class="line">  <span class="keyword">if</span> (tcp_rcv_state_process(sk, skb, skb-&gt;h.th, skb-&gt;len)) &#123;</span><br><span class="line">    rsk = sk;</span><br><span class="line">    <span class="keyword">goto</span> reset;</span><br><span class="line">  &#125;</span><br><span class="line">  TCP_CHECK_TIMER(sk);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">reset:</span><br><span class="line">  tcp_v4_send_reset(rsk, skb);</span><br><span class="line">discard:</span><br><span class="line">  kfree_skb(skb);</span><br><span class="line">  <span class="comment">/* Be careful here. If this function gets more complicated and</span></span><br><span class="line"><span class="comment">   * gcc suffers from register pressure on the x86, sk (in %ebx)</span></span><br><span class="line"><span class="comment">   * might be destroyed here. This current version compiles correctly,</span></span><br><span class="line"><span class="comment">   * but you have been warned.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">csum_err:</span><br><span class="line">  TCP_INC_STATS_BH(TCP_MIB_INERRS);</span><br><span class="line">  <span class="keyword">goto</span> discard;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">处理tcp半连接状态的请求</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_rcv_state_process</span><span class="params">(struct sock *sk, struct sk_buff *skb,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct tcphdr *th, <span class="keyword">unsigned</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> = <span class="title">tcp_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> = <span class="title">inet_csk</span>(<span class="title">sk</span>);</span></span><br><span class="line">  <span class="keyword">int</span> queued = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  tp-&gt;rx_opt.saw_tstamp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (sk-&gt;sk_state) &#123;</span><br><span class="line">  <span class="keyword">case</span> TCP_CLOSE:</span><br><span class="line">    <span class="keyword">goto</span> discard;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> TCP_LISTEN:</span><br><span class="line">    <span class="keyword">if</span>(th-&gt;ack)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(th-&gt;rst)</span><br><span class="line">      <span class="keyword">goto</span> discard;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(th-&gt;syn) &#123;</span><br><span class="line">      <span class="keyword">if</span> (icsk-&gt;icsk_af_ops-&gt;conn_request(sk, skb) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> discard;</span><br><span class="line"></span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_v4_conn_request</span><span class="params">(struct sock *sk, struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inet_request_sock</span> *<span class="title">ireq</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcp_options_received</span> <span class="title">tmp_opt</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">request_sock</span> *<span class="title">req</span>;</span></span><br><span class="line">  __be32 saddr = skb-&gt;nh.iph-&gt;saddr;</span><br><span class="line">  __be32 daddr = skb-&gt;nh.iph-&gt;daddr;</span><br><span class="line">  __u32 isn = TCP_SKB_CB(skb)-&gt;when;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dst_entry</span> *<span class="title">dst</span> = <span class="title">NULL</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYN_COOKIES</span></span><br><span class="line">  <span class="keyword">int</span> want_cookie = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> want_cookie 0 <span class="comment">/* Argh, why doesn't gcc optimize this :( */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Never answer to SYNs send to broadcast or multicast */</span></span><br><span class="line">  <span class="comment">//丢弃广播，多播包</span></span><br><span class="line">  <span class="keyword">if</span> (((struct rtable *)skb-&gt;dst)-&gt;rt_flags &amp;</span><br><span class="line">      (RTCF_BROADCAST | RTCF_MULTICAST))</span><br><span class="line">    <span class="keyword">goto</span> drop;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* TW buckets are converted to open requests without</span></span><br><span class="line"><span class="comment">   * limitations, they conserve resources and peer is</span></span><br><span class="line"><span class="comment">   * evidently real one.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">//半连接队列满了，丢弃</span></span><br><span class="line">  <span class="keyword">if</span> (inet_csk_reqsk_queue_is_full(sk) &amp;&amp; !isn) &#123;</span><br><span class="line">    <span class="comment">//除非使用syn cookies</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYN_COOKIES</span></span><br><span class="line">    <span class="keyword">if</span> (sysctl_tcp_syncookies) &#123;</span><br><span class="line">      want_cookie = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">    <span class="keyword">goto</span> drop;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//全连接队列已经满了， 并且半连接数量大于1, 丢弃报文</span></span><br><span class="line">  <span class="keyword">if</span> (sk_acceptq_is_full(sk) &amp;&amp; inet_csk_reqsk_queue_young(sk) &gt; <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">goto</span> drop;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//分配inet_request_sock数据结构</span></span><br><span class="line">  req = reqsk_alloc(&amp;tcp_request_sock_ops);</span><br><span class="line">  <span class="keyword">if</span> (!req)</span><br><span class="line">    <span class="keyword">goto</span> drop;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TCP_MD5SIG</span></span><br><span class="line">  tcp_rsk(req)-&gt;af_specific = &amp;tcp_request_sock_ipv4_ops;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  tcp_clear_options(&amp;tmp_opt);</span><br><span class="line">  tmp_opt.mss_clamp = <span class="number">536</span>;</span><br><span class="line">  tmp_opt.user_mss  = tcp_sk(sk)-&gt;rx_opt.user_mss;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//tcp 选项处理</span></span><br><span class="line">  tcp_parse_options(skb, &amp;tmp_opt, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (want_cookie) &#123;</span><br><span class="line">    tcp_clear_options(&amp;tmp_opt);</span><br><span class="line">    tmp_opt.saw_tstamp = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (tmp_opt.saw_tstamp &amp;&amp; !tmp_opt.rcv_tsval) &#123;</span><br><span class="line">    <span class="comment">/* Some OSes (unknown ones, but I see them on web server, which</span></span><br><span class="line"><span class="comment">     * contains information interesting only for windows'</span></span><br><span class="line"><span class="comment">     * users) do not send their stamp in SYN. It is easy case.</span></span><br><span class="line"><span class="comment">     * We simply do not advertise TS support.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    tmp_opt.saw_tstamp = <span class="number">0</span>;</span><br><span class="line">    tmp_opt.tstamp_ok  = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  tmp_opt.tstamp_ok = tmp_opt.saw_tstamp;</span><br><span class="line"></span><br><span class="line">  tcp_openreq_init(req, &amp;tmp_opt, skb);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (security_inet_conn_request(sk, skb, req))</span><br><span class="line">    <span class="keyword">goto</span> drop_and_free;</span><br><span class="line"></span><br><span class="line">  ireq = inet_rsk(req);</span><br><span class="line">  ireq-&gt;loc_addr = daddr;</span><br><span class="line">  ireq-&gt;rmt_addr = saddr;</span><br><span class="line">  ireq-&gt;opt = tcp_v4_save_options(sk, skb);</span><br><span class="line">  <span class="keyword">if</span> (!want_cookie)</span><br><span class="line">    TCP_ECN_create_request(req, skb-&gt;h.th);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (want_cookie) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYN_COOKIES</span></span><br><span class="line">    syn_flood_warning(skb);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    isn = cookie_v4_init_sequence(sk, skb, &amp;req-&gt;mss);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isn) &#123;</span><br><span class="line">    struct inet_peer *peer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* VJ's idea. We save last timestamp seen</span></span><br><span class="line"><span class="comment">     * from the destination in peer table, when entering</span></span><br><span class="line"><span class="comment">     * state TIME-WAIT, and check against it before</span></span><br><span class="line"><span class="comment">     * accepting new connection request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If "isn" is not zero, this request hit alive</span></span><br><span class="line"><span class="comment">     * timewait bucket, so that all the necessary checks</span></span><br><span class="line"><span class="comment">     * are made in the function processing timewait state.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (tmp_opt.saw_tstamp &amp;&amp;</span><br><span class="line">        tcp_death_row.sysctl_tw_recycle &amp;&amp;</span><br><span class="line">        (dst = inet_csk_route_req(sk, req)) != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">        (peer = rt_get_peer((struct rtable *)dst)) != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">        peer-&gt;v4daddr == saddr) &#123;</span><br><span class="line">      <span class="keyword">if</span> (xtime.tv_sec &lt; peer-&gt;tcp_ts_stamp + TCP_PAWS_MSL &amp;&amp;</span><br><span class="line">          (s32)(peer-&gt;tcp_ts - req-&gt;ts_recent) &gt;</span><br><span class="line">              TCP_PAWS_WINDOW) &#123;</span><br><span class="line">        NET_INC_STATS_BH(LINUX_MIB_PAWSPASSIVEREJECTED);</span><br><span class="line">        dst_release(dst);</span><br><span class="line">        <span class="keyword">goto</span> drop_and_free;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Kill the following clause, if you dislike this way. */</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!sysctl_tcp_syncookies &amp;&amp;</span><br><span class="line">       (sysctl_max_syn_backlog - inet_csk_reqsk_queue_len(sk) &lt;</span><br><span class="line">        (sysctl_max_syn_backlog &gt;&gt; <span class="number">2</span>)) &amp;&amp;</span><br><span class="line">       (!peer || !peer-&gt;tcp_ts_stamp) &amp;&amp;</span><br><span class="line">       (!dst || !dst_metric(dst, RTAX_RTT))) &#123;</span><br><span class="line">      <span class="comment">/* Without syncookies last quarter of</span></span><br><span class="line"><span class="comment">       * backlog is filled with destinations,</span></span><br><span class="line"><span class="comment">       * proven to be alive.</span></span><br><span class="line"><span class="comment">       * It means that we continue to communicate</span></span><br><span class="line"><span class="comment">       * to destinations, already remembered</span></span><br><span class="line"><span class="comment">       * to the moment of synflood.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      LIMIT_NETDEBUG(KERN_DEBUG <span class="string">"TCP: drop open "</span></span><br><span class="line">               <span class="string">"request from %u.%u.%u.%u/%u\n"</span>,</span><br><span class="line">               NIPQUAD(saddr),</span><br><span class="line">               ntohs(skb-&gt;h.th-&gt;source));</span><br><span class="line">      dst_release(dst);</span><br><span class="line">      <span class="keyword">goto</span> drop_and_free;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isn = tcp_v4_init_sequence(skb);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//发送序号</span></span><br><span class="line">  tcp_rsk(req)-&gt;snt_isn = isn;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//发送syn ack包</span></span><br><span class="line">  <span class="keyword">if</span> (tcp_v4_send_synack(sk, req, dst))</span><br><span class="line">    <span class="keyword">goto</span> drop_and_free;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (want_cookie) &#123;</span><br><span class="line">      reqsk_free(req);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//非cookie模式，添加req 到半连接队列，并且设置超时时间, TCP_TIMEOUT_INIT是3s， </span></span><br><span class="line">    <span class="comment">//3s重传一次，总共5次，这就是syn 攻击的一个原理</span></span><br><span class="line">    inet_csk_reqsk_queue_hash_add(sk, req, TCP_TIMEOUT_INIT);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">drop_and_free:</span><br><span class="line">  reqsk_free(req);</span><br><span class="line">drop:</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tcp_v4_send_synack</span><span class="params">(struct sock *sk, struct request_sock *req,</span></span></span><br><span class="line"><span class="function"><span class="params">            struct dst_entry *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_request_sock</span> *<span class="title">ireq</span> = <span class="title">inet_rsk</span>(<span class="title">req</span>);</span></span><br><span class="line">  <span class="keyword">int</span> err = <span class="number">-1</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> * <span class="title">skb</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First, grab a route. */</span></span><br><span class="line">  <span class="keyword">if</span> (!dst &amp;&amp; (dst = inet_csk_route_req(sk, req)) == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//创建synack包</span></span><br><span class="line">  skb = tcp_make_synack(sk, dst, req);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (skb) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">th</span> = <span class="title">skb</span>-&gt;<span class="title">h</span>.<span class="title">th</span>;</span></span><br><span class="line"></span><br><span class="line">    th-&gt;check = tcp_v4_check(th, skb-&gt;len,</span><br><span class="line">           ireq-&gt;loc_addr,</span><br><span class="line">           ireq-&gt;rmt_addr,</span><br><span class="line">           csum_partial((<span class="keyword">char</span> *)th, skb-&gt;len,</span><br><span class="line">                  skb-&gt;csum));</span><br><span class="line"></span><br><span class="line">    err = ip_build_and_send_pkt(skb, sk, ireq-&gt;loc_addr,</span><br><span class="line">              ireq-&gt;rmt_addr,</span><br><span class="line">              ireq-&gt;opt);</span><br><span class="line">    err = net_xmit_eval(err);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">  dst_release(dst);</span><br><span class="line">  <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct sk_buff * <span class="title">tcp_make_synack</span><span class="params">(struct sock *sk, struct dst_entry *dst,</span></span></span><br><span class="line"><span class="function"><span class="params">         struct request_sock *req)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//滑动窗口大小选择</span></span><br><span class="line">   <span class="comment">//http://blog.csdn.net/zhangskd/article/details/8588202</span></span><br><span class="line">   tcp_select_initial_window(tcp_full_space(sk),</span><br><span class="line">      dst_metric(dst, RTAX_ADVMSS) - (ireq-&gt;tstamp_ok ? TCPOLEN_TSTAMP_ALIGNED : <span class="number">0</span>),</span><br><span class="line">      &amp;req-&gt;rcv_wnd,</span><br><span class="line">      &amp;req-&gt;window_clamp,</span><br><span class="line">      ireq-&gt;wscale_ok,</span><br><span class="line">      &amp;rcv_wscale);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/linux/">linux</a><a href="/tags/tcp-ip/">tcp/ip</a></div><div class="post-nav"><a href="/2018/01/10/2018-01-10-linux-tcp-server-handshake-2/" class="pre">linux tcp 服务端ack接收</a><a href="/2018/01/03/2018-01-03-linux-listen/" class="next">linux listen 过程</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Haprxoy/">Haprxoy</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Https/">Https</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tcp-ip/">tcp/ip</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Haproxy/" style="font-size: 15px;">Haproxy</a> <a href="/tags/负载均衡/" style="font-size: 15px;">负载均衡</a> <a href="/tags/Https/" style="font-size: 15px;">Https</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/tcp-ip/" style="font-size: 15px;">tcp/ip</a> <a href="/tags/dpdk/" style="font-size: 15px;">dpdk</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/08/2018-11-07-numa/">dpdk基础知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/2018-11-06-dpdk-framework/">dpdk 基本框架</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/12/2018-04-12-haproxy-port-reuse/">Haproxy 端口复用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/27/2018-02-26-netfilter/">netfilter 框架及lvs的实现原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/21/2018-01-21-linux-close/">linux close 过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/20/2018-01-20-tcp-rcv/">linux tcp recv 调用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/17/2018-01-17-linux-send/">linux tcp send过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/15/2018-01-15-linux-connect/">linux connect 过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/10/2018-01-10-linux-tcp-server-handshake-2/">linux tcp 服务端ack接收</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/04/2018-04-linux-tcp-server-handshake/">linux tcp 服务端syn包接收</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">天天反水, 美女荷官发牌   ---澳门新葡京.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>